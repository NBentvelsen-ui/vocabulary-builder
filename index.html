<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Builder</title>

    <!-- React + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Excel export library -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        import React, { useState, useEffect } from 'react';
        import { X, Plus, BookOpen, Search, Loader } from 'lucide-react';

        export default function VocabularyBuilder() {
          const [words, setWords] = useState([]);
          const [loading, setLoading] = useState(true);
          const [showForm, setShowForm] = useState(false);
          const [selectedWord, setSelectedWord] = useState(null);
          const [selectedCategory, setSelectedCategory] = useState('All');
          const [searchTerm, setSearchTerm] = useState('');
          const [formData, setFormData] = useState({
            word: '',
            meaning: '',
            sentence: '',
            synonyms: '',
            category: ''
          });

          useEffect(() => {
            loadWords();
          }, []);

          const loadWords = async () => {
            try {
              setLoading(true);
              const result = await window.storage.list('word:', false);

              if (result && result.keys && result.keys.length > 0) {
                const loadedWords = [];
                for (const key of result.keys) {
                  try {
                    const data = await window.storage.get(key, false);
                    if (data && data.value) {
                      loadedWords.push(JSON.parse(data.value));
                    }
                  } catch {
                    console.log("error reading key", key);
                  }
                }
                setWords(loadedWords);
              } else {
                const exampleWords = [
                  {
                    id: Date.now(),
                    word: 'Ephemeral',
                    meaning: 'Lasting for a very short time',
                    sentence: 'The beauty of cherry blossoms is ephemeral.',
                    synonyms: 'fleeting, transient',
                    category: 'Adjectives'
                  }
                ];
                for (const w of exampleWords) {
                  await window.storage.set(`word:${w.id}`, JSON.stringify(w), false);
                }
                setWords(exampleWords);
              }
            } finally {
              setLoading(false);
            }
          };

          const exportToExcel = () => {
            if (!words.length) {
              alert("No words to export.");
              return;
            }

            const exportData = words.map(w => ({
              Word: w.word,
              Meaning: w.meaning,
              Sentence: w.sentence ?? '',
              Synonyms: w.synonyms ?? '',
              Category: w.category ?? '',
            }));

            const sheet = XLSX.utils.json_to_sheet(exportData);
            const book = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(book, sheet, "Vocabulary");

            XLSX.writeFile(book, "vocabulary.xlsx");
          };

          const categories = ['All', ...new Set(words.map(w => w.category).filter(Boolean))];

          const handleSubmit = async (e) => {
            e.preventDefault();
            if (formData.word && formData.meaning) {
              const newWord = { ...formData, id: Date.now() };
              await window.storage.set(`word:${newWord.id}`, JSON.stringify(newWord), false);
              setWords([...words, newWord]);
              setShowForm(false);
              setFormData({ word: '', meaning: '', sentence: '', synonyms: '', category: '' });
            }
          };

          const handleDelete = async (id) => {
            await window.storage.delete(`word:${id}`, false);
            setWords(words.filter(w => w.id !== id));
          };

          const filteredWords = words.filter(w => {
            const matchCategory = selectedCategory === 'All' || w.category === selectedCategory;
            const matchSearch =
              w.word.toLowerCase().includes(searchTerm.toLowerCase()) ||
              w.meaning.toLowerCase().includes(searchTerm.toLowerCase());
            return matchCategory && matchSearch;
          });

          if (loading) {
            return (
              <div className="min-h-screen flex items-center justify-center">
                <Loader className="w-12 h-12 animate-spin text-indigo-600" />
              </div>
            );
          }

          return (
            <div className="min-h-screen p-6 pb-32 bg-gradient-to-br from-blue-50 to-indigo-50">
              <div className="max-w-6xl mx-auto">

                <div className="text-center mb-8">
                  <h1 className="text-4xl font-bold text-indigo-700 flex items-center justify-center gap-3">
                    <BookOpen className="w-10 h-10" />
                    Vocabulary Builder
                  </h1>
                  <p className="text-gray-600">Expand your lexicon, one word at a time</p>
                </div>

                <div className="flex justify-center mb-6">
                  <div className="flex gap-2 bg-white shadow-sm p-2 rounded-lg">
                    {categories.map(cat => (
                      <button
                        key={cat}
                        onClick={() => setSelectedCategory(cat)}
                        className={`px-4 py-2 rounded-md ${
                          selectedCategory === cat
                            ? 'bg-indigo-600 text-white'
                            : 'text-gray-600 hover:bg-gray-100'
                        }`}
                      >
                        {cat}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="flex flex-wrap gap-3 justify-center mb-6">
                  {filteredWords.map(w => (
                    <button
                      key={w.id}
                      onClick={() => setSelectedWord(w)}
                      className="px-4 py-2 bg-white rounded-full shadow hover:shadow-md text-indigo-600 font-medium border hover:border-indigo-200"
                    >
                      {w.word}
                    </button>
                  ))}

                  {filteredWords.length === 0 && (
                    <p className="text-gray-500 text-lg">No words found</p>
                  )}
                </div>

                <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow p-4">
                  <div className="max-w-6xl mx-auto flex gap-3">

                    <div className="relative flex-1">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" />
                      <input
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full pl-10 pr-4 py-3 border rounded-lg"
                        placeholder="Search words..."
                      />
                    </div>

                    <button
                      onClick={exportToExcel}
                      className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700"
                    >
                      Export to Excel
                    </button>

                    <button
                      onClick={() => setShowForm(true)}
                      className="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 flex items-center gap-2"
                    >
                      <Plus className="w-5 h-5" /> Add Word
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<VocabularyBuilder />, document.getElementById('root'));
    </script>
</body>
</html>
